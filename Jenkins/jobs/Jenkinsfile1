import groovy.json.JsonSlurperClassic

def jsonParse(def json){
    new groovy.json.JsonSlurperClassic().parseText(json)
}

pipeline {
    agent any

    environment {
        SERVER_A = "64.23.151.32"  // Servidor origen (HappyCell)
        SERVER_B = "186.4.199.239"  // Servidor destino (Soporte)
        USER_A   = "root"      // Usuario en Servidor A
        USER_B   = "compilacion"        // Usuario en Servidor B
        LOCAL_FILE = "openbravo_20250826_1300.log" // Nombre temporal en C
    }

    stages {
        stage('Descargar desde Servidor A') {
            steps {
                sshagent(['openbravo1']) {
                    script {
                        echo "Descargando archivo desde Servidor A a Jenkins (Servidor C)"
                        
                        // Ruta origen en Servidor A
                        def fileA = "/srv/logsopenbravo/openbravo_20250826_1300.log"

                        // Descarga a directorio de trabajo en Jenkins
                        sh """
                            scp -o StrictHostKeyChecking=no ${USER_A}@${SERVER_A}:${fileA} ${LOCAL_FILE}
                        """
                    }
                }
            }
        }

        stage('Subir a Servidor B') {
            steps {
                sshagent(['Server244']) {
                    script {
                        echo "Subiendo archivo desde Jenkins (Servidor C) a Servidor B"
                        
                        // Ruta destino en Servidor B
                        def destB = "${USER_B}@${SERVER_B}:/home/compilacion/Temp/"

                        sh """
                            scp -o StrictHostKeyChecking=no ${LOCAL_FILE} ${destB}
                        """
                    }
                }
            }
        }

        stage('Limpieza en Jenkins') {
            steps {
                script {
                    echo "Eliminando archivo temporal en Jenkins"
                    sh "rm -f ${LOCAL_FILE}"
                }
            }
        }
    }
}
